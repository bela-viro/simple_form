<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>电动自行车回收</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, sans-serif;
      background-color: #fff;
      color: #333;
    }

    .header {
      background-color: #007aff;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header .back {
      color: #fff;
      text-decoration: none;
      font-size: 16px;
    }

    .header h1 {
      color: #fff;
      font-size: 18px;
      font-weight: normal;
    }

    .form-container {
      padding: 15px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #333;
    }

    .form-group .required {
      color: red;
    }

    .form-group input[type="text"],
    .form-group input[type="tel"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    /* 上传按钮容器：统一尺寸 */
    .upload-btn-wrap {
      position: relative;
      width: 100%;
      height: 120px;
    }

    /* 上传按钮：填满容器 */
    .upload-btn {
      width: 100%;
      height: 100%;
      border: 1px dashed #ddd;
      border-radius: 6px;
      font-size: 14px;
      color: #999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background-color: #fff;
      position: absolute;
      left: 0;
      top: 0;
      z-index: 1;
    }

    .upload-btn::before {
      content: "+";
      font-size: 36px;
      margin-bottom: 8px;
      color: #ccc;
    }

    .upload-btn-wrap input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
      z-index: 2;
    }

    /* 预览容器：匹配上传按钮尺寸 */
    .preview-wrap {
      width: 100%;
      height: 120px;
      margin-top: 8px;
      position: relative;
    }

    /* 预览图片：填满容器 + 自适应规则 */
    .preview-img {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
      display: none;
      /* 默认隐藏，选择图片后显示 */
      z-index: 3;
    }

    .compression-info {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      display: none;
      z-index: 4;
    }

    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid rgba(0, 122, 255, 0.3);
      border-radius: 50%;
      border-top-color: #007aff;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .submit-btn {
      width: 100%;
      padding: 12px;
      background-color: #007aff;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      position: relative;
    }

    .submit-btn:active {
      opacity: 0.8;
    }

    .submit-btn.loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .submit-btn.loading::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin-top: -10px;
      margin-left: -10px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
  </style>
</head>

<body>
  <div class="header">
    <a href="javascript:history.back()" class="back">返回</a>
    <h1>电动自行车回收</h1>
    <span></span>
  </div>

  <div class="form-container">
    <form id="recycleForm" action="#" method="post" enctype="multipart/form-data">
      <!-- 姓名 -->
      <div class="form-group">
        <label><span class="required">*</span>姓名</label>
        <input type="text" name="name" placeholder="请填写姓名" required />
      </div>

      <!-- 电话号码 -->
      <div class="form-group">
        <label><span class="required">*</span>电话号码</label>
        <input type="tel" name="phone" placeholder="请填写电话号码" required />
      </div>

      <!-- 身份证号 -->
      <div class="form-group">
        <label><span class="required">*</span>身份证号</label>
        <input type="text" name="id_card" placeholder="请输入身份证号" required />
      </div>

      <!-- 承诺书（上传+预览） -->
      <div class="form-group">
        <label><span class="required">*</span>承诺书</label>
        <div class="upload-btn-wrap">
          <div class="upload-btn">选择图片</div>
          <input type="file" name="promise_file" accept="image/*" required
            onchange="handleImageUpload(this, 'preview-promise')" />
          <img id="preview-promise" class="preview-img" src="" alt="承诺书预览" style="display: none;" />
          <div class="loading-overlay" id="loading-promise">
            <div class="spinner"></div>
          </div>
        </div>
        <div id="compression-info-promise" class="compression-info"></div>
      </div>

      <!-- 旧车架号（上传+预览） -->
      <div class="form-group">
        <label>旧车架号</label>
        <div class="upload-btn-wrap">
          <div class="upload-btn">选择图片</div>
          <input type="file" name="frame_file" accept="image/*" onchange="handleImageUpload(this, 'preview-frame')" />
          <img id="preview-frame" class="preview-img" src="" alt="旧车架号预览" style="display: none;" />
          <div class="loading-overlay" id="loading-frame">
            <div class="spinner"></div>
          </div>
        </div>
        <div id="compression-info-frame" class="compression-info"></div>
      </div>

      <!-- 旧车发票（上传+预览） -->
      <div class="form-group">
        <label>旧车发票</label>
        <div class="upload-btn-wrap">
          <div class="upload-btn">选择图片</div>
          <input type="file" name="invoice_file" accept="image/*"
            onchange="handleImageUpload(this, 'preview-invoice')" />
          <img id="preview-invoice" class="preview-img" src="" alt="旧车发票预览" style="display: none;" />
          <div class="loading-overlay" id="loading-invoice">
            <div class="spinner"></div>
          </div>
        </div>
        <div id="compression-info-invoice" class="compression-info"></div>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">提交</button>
    </form>
  </div>

  <script>
    // 图片压缩配置
    const COMPRESS_CONFIG = {
      maxWidth: 1200,      // 最大宽度
      maxHeight: 1200,     // 最大高度
      quality: 0.7,        // 压缩质量 (0.7 = 70%)
      maxSizeMB: 1         // 最大文件大小 (MB)
    };

    // 处理图片上传和压缩
    async function handleImageUpload(input, previewId) {
      const file = input.files[0];
      if (!file) return;

      const loadingElement = document.getElementById(`loading-${previewId.split('-')[1]}`);
      const previewElement = document.getElementById(previewId);
      const infoElement = document.getElementById(`compression-info-${previewId.split('-')[1]}`);
      const uploadBtn = input.parentNode.querySelector('.upload-btn');

      // 显示加载动画
      loadingElement.style.display = 'flex';
      previewElement.style.display = 'none';
      infoElement.textContent = '';

      try {
        // 压缩图片
        const compressedFile = await compressImage(file);

        // 显示压缩信息
        const originalSize = (file.size / 1024).toFixed(2);
        const compressedSize = (compressedFile.size / 1024).toFixed(2);
        const reduction = ((1 - compressedFile.size / file.size) * 100).toFixed(1);

        infoElement.textContent = `压缩: ${originalSize}KB → ${compressedSize}KB (节省${reduction}%)`;
        infoElement.style.color = '#007aff';

        // 创建预览
        const reader = new FileReader();
        reader.onload = function (e) {
          previewElement.src = e.target.result;
          previewElement.style.display = 'block';
          uploadBtn.style.display = 'none';
          loadingElement.style.display = 'none';

          // 替换原文件为压缩后的文件
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(compressedFile);
          input.files = dataTransfer.files;
        };
        reader.readAsDataURL(compressedFile);
      } catch (error) {
        console.error('图片压缩失败:', error);
        loadingElement.style.display = 'none';
        infoElement.textContent = '压缩失败，使用原文件';
        infoElement.style.color = 'red';

        // 显示原始图片预览
        const reader = new FileReader();
        reader.onload = function (e) {
          previewElement.src = e.target.result;
          previewElement.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }

    // 图片压缩处理函数
    function compressImage(file) {
      return new Promise((resolve, reject) => {
        // 如果文件小于1MB，不需要压缩
        if (file.size <= COMPRESS_CONFIG.maxSizeMB * 1024 * 1024) {
          resolve(file);
          return;
        }
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => {
          // 计算新尺寸
          let width = img.width;
          let height = img.height;

          if (width > COMPRESS_CONFIG.maxWidth || height > COMPRESS_CONFIG.maxHeight) {
            const ratio = Math.min(
              COMPRESS_CONFIG.maxWidth / width,
              COMPRESS_CONFIG.maxHeight / height
            );
            width = Math.floor(width * ratio);
            height = Math.floor(height * ratio);
          }

          // 创建Canvas进行压缩
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          // 转换为Blob
          canvas.toBlob(
            blob => {
              if (!blob) {
                reject(new Error('图片压缩失败'));
                return;
              }

              // 创建压缩后的文件对象
              const compressedFile = new File([blob], file.name, {
                type: 'image/jpeg',
                lastModified: Date.now()
              });

              URL.revokeObjectURL(img.src);
              resolve(compressedFile);
            },
            'image/jpeg',
            COMPRESS_CONFIG.quality
          );
        };

        img.onerror = () => {
          URL.revokeObjectURL(img.src);
          reject(new Error('图片加载失败'));
        };
      });
    }

    // 表单提交处理
    document.getElementById('recycleForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.classList.add('loading');
      submitBtn.disabled = true;

      // 模拟表单提交
      setTimeout(() => {
        alert('表单提交成功！');
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
      }, 1500);
    });
  </script>
</body>

</html>